# Инструкции по диагностике и устранению неполадок k3s на Raspberry Pi

## Обзор созданных скриптов

В рамках выполнения задачи были созданы следующие PowerShell скрипты для диагностики и устранения неполадок k3s на Raspberry Pi:

1. `scripts/setup-ssh-key.ps1` - Настройка SSH-ключа для автоматического подключения
2. `connect-raspberry.ps1` - Подключение к Raspberry Pi и обновление проекта (улучшенная версия)
3. `check-k3s-with-key.ps1` - Проверка статуса службы k3s с использованием SSH-ключа
4. `k3s-diagnostic.ps1` - Комплексная диагностика и устранение неполадок k3s
5. `k3s-check-instructions.md` - Подробные инструкции по ручной проверке

## Использование скриптов

### 1. Настройка SSH-ключа (рекомендуется)

Перед использованием других скриптов рекомендуется настроить SSH-ключ для автоматического подключения:

```powershell
.\scripts/setup-ssh-key.ps1
```

Скрипт выполнит следующие действия:
- Создаст SSH-ключ, если он еще не существует
- Скопирует публичный ключ на Raspberry Pi
- Настроит автоматическое подключение без ввода пароля

### 2. Комплексная диагностика k3s

Для выполнения комплексной диагностики k3s используйте:

```powershell
.\scripts/k3s-diagnostic.ps1
```

Скрипт выполнит следующие проверки:
- Проверка соединения с Raspberry Pi
- Проверка статуса службы k3s
- Проверка наличия конфигурационного файла kubectl
- Проверка порта, на котором слушает k3s
- Анализ логов службы k3s
- Предложение перезапустить службу при обнаружении проблем

### 3. Быстрая проверка статуса k3s

Для быстрой проверки статуса k3s используйте:

```powershell
.\scripts/check-k3s-with-key.ps1
```

Скрипт выведет:
- Статус службы k3s
- Информацию о конфигурационном файле kubectl
- Порт, на котором слушает k3s
- Последние 50 строк логов службы

### 4. Подключение и обновление проекта

Для подключения к Raspberry Pi и обновления проекта используйте:

```powershell
.\scripts/connect-raspberry.ps1
```

Скрипт выполнит:
- Подключение к Raspberry Pi
- Поиск проекта SubTracker
- Проверку состояния Git-репозитория
- Обновление кода из основной ветки

## Ручная диагностика

Если автоматические скрипты не работают, вы можете выполнить диагностику вручную, следуя инструкциям в файле `k3s-check-instructions.md`.

## Возможные проблемы и их решения

### 1. Ошибка подключения по SSH

**Причина**: Неправильные учетные данные или отсутствие SSH-ключа
**Решение**: 
- Проверьте IP-адрес и имя пользователя
- Выполните `scripts/setup-ssh-key.ps1` для настройки SSH-ключа
- Убедитесь, что Raspberry Pi доступна в сети

### 2. Служба k3s не запущена

**Причина**: Ошибки в конфигурации или проблемы с системой
**Решение**:
- Проверьте логи службы: `sudo journalctl -u k3s -n 50 --no-pager`
- Перезапустите службу: `sudo systemctl restart k3s`
- Проверьте статус после перезапуска: `sudo systemctl status k3s`

### 3. Отсутствует конфигурационный файл kubectl

**Причина**: k3s не создал конфигурационный файл или он был удален
**Решение**:
- Создайте директорию: `mkdir -p ~/.kube`
- Скопируйте конфигурацию: `sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config`
- Установите права: `sudo chown $USER:$USER ~/.kube/config`

### 4. k3s не слушает на стандартном порту

**Причина**: Нестандартная конфигурация k3s
**Решение**:
- Проверьте конфигурационные файлы k3s
- Перезапустите службу с правильными параметрами