name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: üìã Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: üîß Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: üèóÔ∏è Build all modules
        run: ./gradlew build --no-daemon

      - name: üß™ Run tests
        run: ./gradlew test --no-daemon

      - name: üìä Generate test report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: 'Test Results'
          path: '**/build/test-results/test/TEST-*.xml'
          reporter: java-junit

      - name: üì¶ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts
          path: |
            backend/build/libs/*.jar
            web-frontend/build/
            telegram-bot/build/libs/*.jar
          retention-days: 7

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  code-quality:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: üîß Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: üîç Run detekt (Kotlin linter)
        run: ./gradlew detekt --no-daemon
        continue-on-error: true

      - name: üîí Run dependency vulnerability check
        run: ./gradlew dependencyCheckAnalyze --no-daemon
        continue-on-error: true

  # –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  docker-build:
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üèóÔ∏è Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/subtracker-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/subtracker-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
  integration-tests:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: üîß Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: üß™ Run integration tests with SQLite
        run: |
          ./gradlew :backend:build --no-daemon
          timeout 30s ./gradlew :backend:run --no-daemon &
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints
          curl -f http://localhost:8080/login -X POST \
            -H "Content-Type: application/json" \
            -d '{"username":"user","password":"user"}' || exit 1
          
          curl -f http://localhost:8080/register -X POST \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","email":"test@test.com","password":"test"}' || exit 1

      - name: üåê Test web frontend files
        run: |
          cd web-frontend/src/jsMain/resources
          python3 -m http.server 3000 &
          sleep 5
          curl -f http://localhost:3000/ || exit 1
          curl -f http://localhost:3000/register.html || exit 1
          curl -f http://localhost:3000/dashboard.html || exit 1

  # –î–µ–ø–ª–æ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  deploy:
    runs-on: ubuntu-latest
    needs: [docker-build, integration-tests]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: üöÄ Deploy to production server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Docker –æ–±—Ä–∞–∑–æ–≤
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/subtracker-backend:latest
            
            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker stop subtracker-backend || true
            docker rm subtracker-backend || true
            
            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            docker run -d \
              --name subtracker-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              -v /opt/subtracker/data:/app/data \
              -e DATABASE_URL="jdbc:sqlite:/app/data/subtracker.db" \
              ${{ secrets.DOCKERHUB_USERNAME }}/subtracker-backend:latest
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞
            sleep 10
            curl -f http://localhost:8080/login -X POST \
              -H "Content-Type: application/json" \
              -d '{"username":"user","password":"user"}' || exit 1

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –¥–µ–ø–ª–æ—è
  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: üìß Notify deployment status
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          status: ${{ needs.deploy.result }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: üìã Create release on success
        if: needs.deploy.result == 'success'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ –∏–∑ –≤–µ—Ç–∫–∏ main
            
            ## –ò–∑–º–µ–Ω–µ–Ω–∏—è:
            - Commit: ${{ github.sha }}
            - Author: ${{ github.actor }}
            - Workflow: ${{ github.workflow }}
            
            ## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
            - ‚úÖ Backend API (SQLite)
            - ‚úÖ Web Frontend (HTML/CSS/JS)
            - ‚úÖ Telegram Bot
            
            ## –ü—Ä–æ–≤–µ—Ä–∫–∏:
            - ‚úÖ –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç—ã
            - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
            - ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
            - ‚úÖ Docker –æ–±—Ä–∞–∑—ã
            - ‚úÖ –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
          draft: false
          prerelease: false